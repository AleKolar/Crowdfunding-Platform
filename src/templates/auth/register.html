<!-- src/templates/auth/register.html -->
{% extends "base.html" %}

{% block title %}–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è - Crowdfunding{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
        <div class="card card-custom">
            <div class="card-body p-4">
                <h2 class="text-center mb-4">üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <p class="text-center text-muted mb-4">
                    –°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫–æ –≤—Å–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
                </p>

                <form id="registerForm">
                    <div class="mb-3">
                        <label for="email" class="form-label">üìß Email</label>
                        <input type="email" class="form-control" id="email" name="email"
                               placeholder="your@email.com" required>
                    </div>

                    <div class="mb-3">
                        <label for="phone" class="form-label">üìû –¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="tel" class="form-control" id="phone" name="phone"
                               placeholder="+7 (999) 999-99-99" required>
                    </div>

                    <div class="mb-3">
                        <label for="username" class="form-label">üë§ –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <input type="text" class="form-control" id="username" name="username"
                               placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –∏–º—è" required>
                    </div>

                    <div class="mb-3">
                        <label for="password" class="form-label">üîí –ü–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-control" id="password" name="password"
                               placeholder="–ù–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤" required minlength="6">
                    </div>

                    <div class="mb-4">
                        <label for="secret_code" class="form-label">üîê –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ (4 —Ü–∏—Ñ—Ä—ã)</label>
                        <input type="text" class="form-control" id="secret_code" name="secret_code"
                               placeholder="1234" pattern="[0-9]{4}" maxlength="4" required>
                        <div class="form-text">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-custom w-100 py-2">
                        üöÄ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                    </button>
                </form>

                <div class="text-center mt-3">
                    <small class="text-muted">
                        –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="/login" class="text-decoration-none">–í–æ–π–¥–∏—Ç–µ</a>
                    </small>
                </div>

                <!-- –ë–ª–æ–∫ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
                <div id="result" class="mt-4"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('registerForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    submitBtn.innerHTML = '‚è≥ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';
    submitBtn.disabled = true;

    const formData = new FormData(this);
    const data = {
        email: formData.get('email'),
        phone: formData.get('phone'),
        username: formData.get('username'),
        password: formData.get('password'),
        secret_code: formData.get('secret_code')
    };

    console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', data);

    try {
        const response = await fetch('/auth/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
            // –£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            document.getElementById('result').innerHTML = `
                <div class="alert alert-success">
                    <h5>‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!</h5>
                    <p>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${result.user_id}</p>
                    <p>Email: ${result.email}</p>
                    <p class="mb-0">${result.message}</p>
                </div>
            `;

            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            this.reset();

            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                window.location.href = '/login';
            }, 3000);

        } else {
            // –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            document.getElementById('result').innerHTML = `
                <div class="alert alert-danger">
                    <h5>‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</h5>
                    <p class="mb-0">${result.detail || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'}</p>
                </div>
            `;
        }

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞:', error);
        document.getElementById('result').innerHTML = `
            <div class="alert alert-danger">
                <h5>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</h5>
                <p class="mb-0">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É</p>
            </div>
        `;
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
document.getElementById('phone').addEventListener('input', function(e) {
    // –†–∞–∑—Ä–µ—à–∞–µ–º: —Ü–∏—Ñ—Ä—ã, +, (), –ø—Ä–æ–±–µ–ª—ã –∏ –¥–µ—Ñ–∏—Å
    this.value = this.value.replace(/[^\d+()\s\-]/g, '');
});

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ–¥–∞
document.getElementById('secret_code').addEventListener('input', function(e) {
    this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4);
});
</script>
{% endblock %}
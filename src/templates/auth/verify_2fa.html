<!-- src/templates/emails/verify_2fa.html -->
{% extends "base.html" %}

{% block title %}–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ 2FA - Crowdfunding{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
        <div class="card card-custom">
            <div class="card-body p-4">
                <h2 class="text-center mb-4">üì± –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—Ö–æ–¥–∞</h2>
                <p class="text-center text-muted mb-4">
                    –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –Ω–∞ –≤–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω –∏ email
                </p>

                <form id="verify2faForm">
                    <input type="hidden" id="user_email" name="email">

                    <div class="mb-4">
                        <label for="sms_code" class="form-label">üîê –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (6 —Ü–∏—Ñ—Ä)</label>
                        <input type="text" class="form-control" id="sms_code" name="sms_code"
                               placeholder="123456" pattern="[0-9]{6}" maxlength="6" required>
                        <div class="form-text">
                            –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ SMS –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω –∏ –ø–æ Email. –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 10 –º–∏–Ω—É—Ç.
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success btn-custom w-100 py-2">
                        ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                    </button>
                </form>

                <div class="text-center mt-3">
                    <button id="resendCode" class="btn btn-link text-decoration-none">
                        üîÑ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ
                    </button>
                </div>

                <!-- –ë–ª–æ–∫ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
                <div id="result" class="mt-4"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ó–∞–ø–æ–ª–Ω—è–µ–º email –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–ª–∏ localStorage
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email') || localStorage.getItem('login_email');

    if (email) {
        document.getElementById('user_email').value = email;
        localStorage.setItem('login_email', email);
    }
});

document.getElementById('verify2faForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;

    submitBtn.innerHTML = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
    submitBtn.disabled = true;

    const formData = new FormData(this);
    const data = {
        email: formData.get('email'),
        sms_code: formData.get('sms_code')
    };

    try {
        const response = await fetch('/auth/verify-2fa', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
            document.getElementById('result').innerHTML = `
                <div class="alert alert-success">
                    <h5>‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!</h5>
                    <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</p>
                </div>
            `;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
            if (result.access_token) {
                localStorage.setItem('auth_token', result.access_token);
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 2000);
            }

        } else {
            document.getElementById('result').innerHTML = `
                <div class="alert alert-danger">
                    <h5>‚ùå –û—à–∏–±–∫–∞</h5>
                    <p class="mb-0">${result.detail || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥'}</p>
                </div>
            `;
        }

    } catch (error) {
        document.getElementById('result').innerHTML = `
            <div class="alert alert-danger">
                <h5>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</h5>
                <p class="mb-0">${error.message}</p>
            </div>
        `;
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});

// –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–æ–≤
document.getElementById('resendCode').addEventListener('click', async function() {
    const email = document.getElementById('user_email').value;

    if (!email) {
        alert('‚ùå Email –Ω–µ —É–∫–∞–∑–∞–Ω');
        return;
    }

    const btn = this;
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
    btn.disabled = true;

    try {
        const response = await fetch('/auth/resend-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email: email })
        });

        const result = await response.json();

        if (response.ok) {
            alert('‚úÖ –ù–æ–≤—ã–µ –∫–æ–¥—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–æ SMS –∏ Email!');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–æ–¥—ã –≤ development
            if (result.test_sms_code && result.test_email_code) {
                document.getElementById('result').innerHTML = `
                    <div class="alert alert-info">
                        <h6>üîê –¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú</h6>
                        <p><strong>SMS –∫–æ–¥:</strong> ${result.test_sms_code}</p>
                        <p><strong>Email –∫–æ–¥:</strong> ${result.test_email_code}</p>
                        <small class="text-muted">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª—é–±–æ–π –∏–∑ —ç—Ç–∏—Ö –∫–æ–¥–æ–≤</small>
                    </div>
                `;
            }
        } else {
            alert(`‚ùå ${result.detail || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'}`);
        }

    } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
});
</script>
{% endblock %}


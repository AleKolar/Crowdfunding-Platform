<!-- src/templates/auth/login.html -->
{% extends "base.html" %}

{% block title %}–í—Ö–æ–¥ - Crowdfunding{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
        <div class="card card-custom">
            <div class="card-body p-4">
                <h2 class="text-center mb-4">üîê –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
                <p class="text-center text-muted mb-4">
                    –í–≤–µ–¥–∏—Ç–µ email –∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞
                </p>

                <form id="loginForm">
                    <div class="mb-3">
                        <label for="email" class="form-label">üìß Email</label>
                        <input type="email" class="form-control" id="email" name="email"
                               placeholder="your@email.com" required>
                    </div>

                    <div class="mb-4">
                        <label for="secret_code" class="form-label">üîê –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ (4 —Ü–∏—Ñ—Ä—ã)</label>
                        <input type="text" class="form-control" id="secret_code" name="secret_code"
                               placeholder="1234" pattern="[0-9]{4}" maxlength="4" required>
                        <div class="form-text">–¢–æ—Ç –∂–µ –∫–æ–¥, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-custom w-100 py-2">
                        üîë –í–æ–π—Ç–∏
                    </button>
                </form>

                <div class="text-center mt-3">
                    <small class="text-muted">
                        –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="/register" class="text-decoration-none">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a>
                    </small>
                </div>

                <!-- –ë–ª–æ–∫ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
                <div id="result" class="mt-4"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    submitBtn.innerHTML = '‚è≥ –í—Ö–æ–¥...';
    submitBtn.disabled = true;

    const formData = new FormData(this);
    const data = {
        email: formData.get('email'),
        secret_code: formData.get('secret_code')
    };

    console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤—Ö–æ–¥–∞:', data);

    try {
        const response = await fetch('/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
            // ‚úÖ –£–°–ü–ï–®–ù–´–ô –í–•–û–î - –ü–û–ö–ê–ó–´–í–ê–ï–ú –ö–û–î–´ –ò –ü–†–ï–î–õ–ê–ì–ê–ï–ú –ü–ï–†–ï–ô–¢–ò
            let successHtml = `
                <div class="alert alert-success">
                    <h5>‚úÖ –ü–µ—Ä–≤—ã–π —ç—Ç–∞–ø –ø—Ä–æ–π–¥–µ–Ω!</h5>
                    <p>${result.message}</p>
            `;

            // ‚úÖ –î–û–ë–ê–í–õ–Ø–ï–ú –¢–ï–°–¢–û–í–´–ï –ö–û–î–´ –ï–°–õ–ò –ï–°–¢–¨
            if (result.test_sms_code && result.test_email_code) {
                successHtml += `
                    <div class="mt-3 p-3 bg-light border rounded">
                        <h6>üîê –¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú</h6>
                        <p class="mb-1"><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${result.user_phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p class="mb-1"><strong>Email:</strong> ${result.user_email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p class="mb-1"><strong>SMS –∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞:</strong></p>
                        <h4 class="text-center text-primary">${result.test_sms_code}</h4>
                        <p class="mb-1"><strong>Email –∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞:</strong></p>
                        <h4 class="text-center text-primary">${result.test_email_code}</h4>
                        <small class="text-muted">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª—é–±–æ–π –∏–∑ —ç—Ç–∏—Ö –∫–æ–¥–æ–≤ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —ç—Ç–∞–ø–µ</small>
                    </div>
                `;
            }

            successHtml += `</div>`;

            document.getElementById('result').innerHTML = successHtml;

            // ‚úÖ –°–û–•–†–ê–ù–Ø–ï–ú EMAIL –ò USER_ID –î–õ–Ø –°–õ–ï–î–£–Æ–©–ï–ì–û –≠–¢–ê–ü–ê
            localStorage.setItem('login_email', data.email);
            localStorage.setItem('user_id', result.user_id);

            // ‚úÖ –ü–†–ï–î–õ–ê–ì–ê–ï–ú –ü–ï–†–ï–ô–¢–ò –ö 2FA –ß–ï–†–ï–ó 2 –°–ï–ö–£–ù–î–´
            setTimeout(() => {
                const goTo2FA = confirm('–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—é –∫–æ–¥–∞?');
                if (goTo2FA) {
                    window.location.href = '/verify-2fa?email=' + encodeURIComponent(data.email) + '&user_id=' + result.user_id;
                }
            }, 2000);

        } else {
            // ‚ùå –û–®–ò–ë–ö–ê –í–•–û–î–ê
            document.getElementById('result').innerHTML = `
                <div class="alert alert-danger">
                    <h5>‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞</h5>
                    <p class="mb-0">${result.detail || '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'}</p>
                </div>
            `;
        }

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞:', error);
        document.getElementById('result').innerHTML = `
            <div class="alert alert-danger">
                <h5>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</h5>
                <p class="mb-0">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É</p>
            </div>
        `;
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ–¥–∞
document.getElementById('secret_code').addEventListener('input', function(e) {
    // –¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã, –º–∞–∫—Å–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞
    this.value = this.value.replace(/[^\d]/g, '').slice(0, 4);
});

// ‚úÖ –î–û–ë–ê–í–õ–Ø–ï–ú –í–û–ó–ú–û–ñ–ù–û–°–¢–¨ –ë–´–°–¢–†–û–ì–û –ü–ï–†–ï–•–û–î–ê –ö 2FA
document.addEventListener('DOMContentLoaded', function() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–∏—à–ª–∏ –ª–∏ –º—ã —Å—é–¥–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    const urlParams = new URLSearchParams(window.location.search);
    const registeredEmail = urlParams.get('registered_email');

    if (registeredEmail) {
        document.getElementById('email').value = registeredEmail;
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
        const hint = document.createElement('div');
        hint.className = 'alert alert-info mt-3';
        hint.innerHTML = 'üéâ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞.';
        document.getElementById('loginForm').parentNode.insertBefore(hint, document.getElementById('loginForm'));
    }
});
</script>
{% endblock %}
<!-- templates/projects.html -->
{% extends "base.html" %}

{% block title %}–ü—Ä–æ–µ–∫—Ç—ã - Crowdfunding{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>üöÄ –í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</h1>
    <button class="btn btn-primary" onclick="showCreateProjectModal()">‚ûï –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
              <label for="search-input"></label><input type="text" class="form-control" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤...">
            </div>
            <div class="col-md-3">
              <label for="category-filter"></label><select class="form-select" id="category-filter">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    <option value="technology">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</option>
                    <option value="art">–ò—Å–∫—É—Å—Å—Ç–≤–æ</option>
                    <option value="business">–ë–∏–∑–Ω–µ—Å</option>
                </select>
            </div>
            <div class="col-md-3">
              <label for="status-filter"></label><select class="form-select" id="status-filter">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                    <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-outline-secondary w-100" onclick="loadProjects()">üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –°–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤ -->
<div id="projects-container">
    <div class="text-center py-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <p class="mt-2">–ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã...</p>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ -->
<div class="modal fade" id="createProjectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="create-project-form">
                    <div class="mb-3">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
                      <label>
                        <input type="text" class="form-control" name="title" required>
                      </label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                      <label>
                        <textarea class="form-control" name="description" rows="3" required></textarea>
                      </label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞</label>
                      <label>
                        <input type="number" class="form-control" name="goal_amount" min="1" required>
                      </label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                      <label>
                        <select class="form-select" name="category" required>
                            <option value="technology">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</option>
                            <option value="art">–ò—Å–∫—É—Å—Å—Ç–≤–æ</option>
                            <option value="business">–ë–∏–∑–Ω–µ—Å</option>
                        </select>
                      </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="createProject()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
let allProjects = [];

async function loadProjects() {
    try {
        const search = document.getElementById('search-input').value;
        const category = document.getElementById('category-filter').value;
        const status = document.getElementById('status-filter').value;

        let url = `${API_BASE}/projects/`;
        const params = new URLSearchParams();

        if (search) params.append('query', search);
        if (category) params.append('category', category);
        if (status) params.append('status', status);

        if (params.toString()) url += `?${params.toString()}`;

        const response = await makeAuthenticatedRequest(url);

        if (response.ok) {
            allProjects = await response.json();
            renderProjects(allProjects);
        } else {
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤');
        }
    } catch (error) {
        showError(error.message);
    }
}

function renderProjects(projects) {
    const container = document.getElementById('projects-container');

    if (projects.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <h4>üòî –ü—Ä–æ–µ–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
                <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
            </div>
        `;
        return;
    }

    container.innerHTML = projects.map(project => `
        <div class="card mb-3 project-card" onclick="openProject(${project.id})" style="cursor: pointer;">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h5 class="card-title">${project.title}</h5>
                        <p class="card-text text-muted">${project.description}</p>
                        <div class="d-flex gap-3 text-sm">
                            <span class="badge bg-primary">${project.category}</span>
                            <span class="badge bg-${project.status === 'active' ? 'success' : 'secondary'}">${project.status}</span>
                            <span>üéØ ${project.goal_amount} ‚ÇΩ</span>
                            <span>üëÅÔ∏è ${project.views || 0}</span>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group">
                            <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); likeProject(${project.id})">
                                ‚ù§Ô∏è ${project.likes_count || 0}
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="event.stopPropagation(); donateToProject(${project.id})">
                                üí∞ –î–æ–Ω–∞—Ç
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function showCreateProjectModal() {
    if (!authToken) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É!');
        return;
    }
    new bootstrap.Modal(document.getElementById('createProjectModal')).show();
}

async function createProject() {
    try {
        const form = document.getElementById('create-project-form');
        const formData = new FormData(form);

        const projectData = {
            title: formData.get('title'),
            description: formData.get('description'),
            goal_amount: parseFloat(formData.get('goal_amount')),
            category: formData.get('category')
        };

        const response = await makeAuthenticatedRequest(`${API_BASE}/projects/`, {
            method: 'POST',
            body: JSON.stringify(projectData)
        });

        if (response.ok) {
            const project = await response.json();
            bootstrap.Modal.getInstance(document.getElementById('createProjectModal')).hide();
            showSuccess('–ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω!');
            loadProjects(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
        } else {
            const error = await response.json();
            showError(error.detail);
        }
    } catch (error) {
        showError(error.message);
    }
}

function openProject(projectId) {
    window.location.href = `/project/${projectId}`;
}

async function likeProject(projectId) {
    try {
        const response = await makeAuthenticatedRequest(`${API_BASE}/projects/${projectId}/like`, {
            method: 'POST'
        });

        if (response.ok) {
            showSuccess('–õ–∞–π–∫ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω!');
            loadProjects(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
        } else {
            const error = await response.json();
            showError(error.detail);
        }
    } catch (error) {
        showError(error.message);
    }
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    if (authToken) {
        loadProjects();
    } else {
        document.getElementById('projects-container').innerHTML = `
            <div class="text-center py-5">
                <h4>üîê –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h4>
                <p>–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤</p>
                <button class="btn btn-primary" onclick="window.location.href='/dashboard'">–í–æ–π—Ç–∏</button>
            </div>
        `;
    }
});
</script>
{% endblock %}